name: CI # Nom du workflow GitHub Actions

on:
  push:
    branches:
      - master # DÃ©clencheur sur push vers master
  pull_request: # DÃ©clencheur aussi sur les pull requests
  workflow_dispatch: # DÃ©clenchement manuel via l'interface GitHub

permissions:
  actions: read
  contents: read
  pull-requests: write

jobs:
  main:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      max-parallel: 3

    steps:
      - name: RÃ©cupÃ©ration du dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Mise en cache de node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Installation des dÃ©pendances
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          npm ci --legacy-peer-deps
          echo "âœ… DÃ©pendances installÃ©es"

      - name: DÃ©finir les SHAs Nx
        uses: nrwl/nx-set-shas@v4

      - name: ExÃ©cuter le Lint
        run: |
          echo "ğŸ” Lint des projets affectÃ©s..."
          NX_CLOUD=false npx nx affected --target=lint || true
          echo "âœ… Lint terminÃ©"

      - name: Tests unitaires
        run: |
          echo "ğŸ§ª Lancement des tests unitaires..."
          NX_CLOUD=false npx nx affected --target=test
          echo "âœ… Tests terminÃ©s"

      - name: Compilation des projets affectÃ©s
        run: |
          echo "ğŸ—ï¸ Compilation des projets..."
          NX_CLOUD=false npx nx affected --target=build
          echo "âœ… Build terminÃ©"
        timeout-minutes: 30

      - name: GÃ©nÃ©ration du graphe de dÃ©pendances
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration du graphe des dÃ©pendances..."
          NX_CLOUD=false npx nx dep-graph --file=dist/graph.html
          echo "âœ… Graphe gÃ©nÃ©rÃ©"

      - name: Applications affectÃ©es
        run: |
          echo "ğŸ“¦ Liste des applications affectÃ©es :"
          NX_CLOUD=false npx nx show projects --affected --type=app

      - name: Librairies affectÃ©es
        run: |
          echo "ğŸ“š Liste des librairies affectÃ©es :"
          NX_CLOUD=false npx nx show projects --affected --type=lib

      - name: DÃ©ploiement des projets affectÃ©s
        run: |
          echo "ğŸš€ DÃ©ploiement en cours..."
          NX_CLOUD=false npx nx affected --target=deploy
          echo "âœ… DÃ©ploiement terminÃ©"

      - name: Tests avec couverture
        run: |
          echo "ğŸ“ˆ Tests avec gÃ©nÃ©ration de couverture..."
          NX_CLOUD=false npx nx affected --target=test --coverage

      - name: Compilation d'un projet spÃ©cifique
        run: |
          echo "ğŸ”§ Build du projet spÃ©cifique..."
          NX_CLOUD=false npx nx build my-fullstack-app

      - name: GÃ©nÃ©ration du timestamp
        run: echo "timestamp=$(date +%s)" >> "$GITHUB_ENV"

      - name: TÃ©lÃ©verser l'artefact de build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ env.timestamp }}
          path: apps/my-fullstack-app/dist

      - name: TÃ©lÃ©verser le graphe de dÃ©pendances
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph-${{ env.timestamp }}
          path: dist/**/*

      - name: RÃ©sumÃ© Markdown visuel
        run: |
          echo "## âœ… RÃ©sumÃ© de l'exÃ©cution du workflow" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ DÃ©pendances installÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Lint terminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª Tests OK" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ Build effectuÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Couverture gÃ©nÃ©rÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Graphe de dÃ©pendances prÃªt" >> $GITHUB_STEP_SUMMARY

      - name: Commentaire automatique dans la PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ” RÃ©sultats CI
            âœ… Lint, build et tests passÃ©s avec succÃ¨s.
            ğŸ“Š [TÃ©lÃ©charger le graphe de dÃ©pendances](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) dans les artefacts.
